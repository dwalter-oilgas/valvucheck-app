<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ValvuCheck - Calibraci√≥n de V√°lvulas</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #FF6B35; --primary-dark: #E85A2A;
            --secondary: #004E89; --accent: #00D9FF;
            --dark: #1A1A2E; --light: #F8F9FA;
            --success: #06D6A0; --warning: #FFB800;
            --danger: #EF476F; --border: #E0E0E0;
            --shadow: rgba(0,0,0,0.08);
            --gradient: linear-gradient(135deg, #FF6B35 0%, #E85A2A 100%);
        }
        body { font-family: 'Manrope', sans-serif; background: linear-gradient(180deg, #F8F9FA 0%, #E8EEF2 100%); color: var(--dark); min-height: 100vh; }
        .app-container { max-width: 900px; margin: 0 auto; padding: 20px; padding-bottom: 80px; }
        .app-header { background: var(--gradient); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(255,107,53,0.2); position: relative; overflow: hidden; }
        .app-header::before { content: ''; position: absolute; top: -50%; right: -20%; width: 300px; height: 300px; background: rgba(255,255,255,0.1); border-radius: 50%; }
        .app-header h1 { color: white; font-size: 32px; font-weight: 800; margin-bottom: 8px; position: relative; z-index: 1; }
        .app-header .subtitle { color: rgba(255,255,255,0.9); font-size: 16px; font-weight: 500; position: relative; z-index: 1; }
        .sync-status { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 8px 16px; border-radius: 20px; color: white; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; z-index: 2; }
        .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.5; } }
        .nav-tabs { display: flex; gap: 12px; margin-bottom: 30px; background: white; padding: 8px; border-radius: 16px; box-shadow: 0 4px 20px var(--shadow); }
        .nav-tab { flex: 1; padding: 14px 20px; border: none; background: transparent; color: var(--dark); font-weight: 600; font-size: 15px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; font-family: 'Manrope', sans-serif; }
        .nav-tab.active { background: var(--gradient); color: white; box-shadow: 0 4px 12px rgba(255,107,53,0.3); }
        .card { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 4px 20px var(--shadow); animation: fadeInUp 0.5s ease; }
        @keyframes fadeInUp { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }
        .card-title { font-size: 20px; font-weight: 700; margin-bottom: 20px; color: var(--dark); display: flex; align-items: center; gap: 10px; }
        .card-title::before { content: ''; width: 4px; height: 24px; background: var(--gradient); border-radius: 2px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--dark); font-size: 14px; }
        .form-input { width: 100%; padding: 14px 16px; border: 2px solid var(--border); border-radius: 12px; font-size: 15px; font-family: 'Manrope', sans-serif; transition: all 0.3s ease; background: white; }
        .form-input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(255,107,53,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }
        .btn { padding: 16px 32px; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; transition: all 0.3s ease; font-family: 'Manrope', sans-serif; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-primary { background: var(--gradient); color: white; box-shadow: 0 4px 16px rgba(255,107,53,0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,107,53,0.4); }
        .btn-secondary { background: white; color: var(--dark); border: 2px solid var(--border); }
        .btn-success { background: var(--success); color: white; }
        .btn-full { width: 100%; }
        .order-card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 12px; border-left: 4px solid var(--primary); box-shadow: 0 4px 12px var(--shadow); cursor: pointer; transition: all 0.3s ease; }
        .order-card:hover { transform: translateX(4px); box-shadow: 0 6px 16px var(--shadow); }
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .order-title { font-weight: 700; font-size: 18px; color: var(--dark); }
        .order-badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; text-transform: uppercase; }
        .badge-complete { background: rgba(6,214,160,0.2); color: var(--success); }
        .badge-draft { background: rgba(255,184,0,0.2); color: var(--warning); }
        .order-details { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; font-size: 14px; color: #666; }
        .detail-label { font-weight: 600; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--dark); color: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.3); animation: slideInRight 0.3s ease; z-index: 1000; font-weight: 600; }
        @keyframes slideInRight { from { transform:translateX(400px); opacity:0; } to { transform:translateX(0); opacity:1; } }
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .photo-upload { border: 2px dashed var(--border); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; width: 100%; background: var(--light); }
        .photo-upload:hover { border-color: var(--primary); background: rgba(255,107,53,0.05); }
        .photo-upload input { display: none; }
        .photo-thumb { position: relative; width: 100%; aspect-ratio: 1; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 12px var(--shadow); }
        .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .photo-remove { position: absolute; top: 4px; right: 4px; background: var(--danger); color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
        .photo-label { font-size: 12px; font-weight: 700; text-align: center; margin-top: 8px; color: #666; text-transform: uppercase; }
        .photos-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 16px; margin-top: 8px; }
        .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; padding: 10px 14px; border: 2px solid var(--border); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .checkbox-item.checked { border-color: var(--primary); background: rgba(255,107,53,0.05); }
        .checkbox-item input { width: 18px; height: 18px; accent-color: var(--primary); }
        .dim-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .dim-table th { background: var(--light); padding: 10px 12px; text-align: left; font-weight: 700; border: 1px solid var(--border); font-size: 12px; text-transform: uppercase; }
        .dim-table td { padding: 8px 12px; border: 1px solid var(--border); }
        .dim-table input { border: none; background: transparent; width: 100%; font-family: 'Manrope', sans-serif; font-size: 14px; }
        .dim-table input:focus { outline: none; }
        .signature-canvas { width: 100%; height: 150px; border: 2px solid var(--border); border-radius: 12px; cursor: crosshair; touch-action: none; }
        .btn-group { display: flex; gap: 12px; margin-top: 20px; }
        .loading { text-align: center; padding: 40px; color: #999; }
        @media (max-width: 768px) {
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .photos-grid { grid-template-columns: repeat(2,1fr); }
            .order-details { grid-template-columns: 1fr 1fr; }
            .checkbox-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

// Firebase
const firebaseConfig = {
    apiKey: "AIzaSyCROCn8bb41my-b5Yj4anDBqgb-v-SfhB0",
    authDomain: "valvucheck.firebaseapp.com",
    projectId: "valvucheck",
    storageBucket: "valvucheck.firebasestorage.app",
    messagingSenderId: "550814428039",
    appId: "1:550814428039:web:9ec559c1a52a2f47340122"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Cloudinary
const CLOUD_NAME = 'dfixfq9s2';
const UPLOAD_PRESET = 'x9roo5ni';

const uploadPhoto = async (base64) => {
    try {
        const fd = new FormData();
        fd.append('file', base64);
        fd.append('upload_preset', UPLOAD_PRESET);
        fd.append('folder', 'valvucheck');
        const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, { method: 'POST', body: fd });
        if (!res.ok) return base64;
        const data = await res.json();
        return data.secure_url;
    } catch { return base64; }
};

// Storage
const Storage = {
    getOrders: (cb) => db.collection('workOrders').onSnapshot(snap => {
        const orders = [];
        snap.forEach(doc => orders.push({ ...doc.data(), firestoreId: doc.id }));
        orders.sort((a, b) => new Date(b.updatedAt||0) - new Date(a.updatedAt||0));
        cb(orders);
    }, () => cb([])),

    saveOrder: async (order) => {
        try {
            const clean = JSON.parse(JSON.stringify(order, (k,v) => v === undefined ? '' : v));
            if (order.firestoreId) {
                await db.collection('workOrders').doc(order.firestoreId).set(clean);
            } else {
                await db.collection('workOrders').add(clean);
            }
            return true;
        } catch (e) {
            alert('Error al guardar: ' + e.message);
            return false;
        }
    }
};

// Toast
function Toast({ message, type, onClose }) {
    useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, []);
    return <div className={`toast ${type}`}>{message}</div>;
}

// Photo slot - one photo per slot
function PhotoSlot({ label, photo, onChange, uploading }) {
    const handleFile = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (ev) => {
            const url = await uploadPhoto(ev.target.result);
            onChange(url);
        };
        reader.readAsDataURL(file);
    };

    return (
        <div>
            {photo ? (
                <div className="photo-thumb">
                    <img src={photo} alt={label} />
                    <button className="photo-remove" onClick={() => onChange('')}>√ó</button>
                </div>
            ) : (
                <label className="photo-upload" style={{ display: 'block', cursor: uploading ? 'wait' : 'pointer' }}>
                    <input type="file" accept="image/*" capture="environment" onChange={handleFile} disabled={uploading} />
                    <div style={{ fontSize: '28px', marginBottom: '6px' }}>üì∑</div>
                    <div style={{ fontSize: '12px', color: '#999' }}>{uploading ? 'Subiendo...' : 'Tomar foto'}</div>
                </label>
            )}
            <div className="photo-label">{label}</div>
        </div>
    );
}

// Signature
function SignaturePad({ sig, onChange }) {
    const ref = useRef(null);
    const [drawing, setDrawing] = useState(false);
    useEffect(() => {
        if (!ref.current) return;
        const ctx = ref.current.getContext('2d');
        ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
        if (sig) { const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = sig; }
    }, []);
    const pos = (e) => {
        const r = ref.current.getBoundingClientRect();
        return { x: (e.clientX||e.touches[0].clientX)-r.left, y: (e.clientY||e.touches[0].clientY)-r.top };
    };
    const start = (e) => { setDrawing(true); const ctx = ref.current.getContext('2d'); const p = pos(e); ctx.beginPath(); ctx.moveTo(p.x, p.y); };
    const draw = (e) => { if (!drawing) return; e.preventDefault(); const ctx = ref.current.getContext('2d'); const p = pos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
    const stop = () => { if (drawing) { setDrawing(false); onChange(ref.current.toDataURL()); } };
    const clear = () => { const ctx = ref.current.getContext('2d'); ctx.clearRect(0, 0, ref.current.width, ref.current.height); onChange(''); };
    return (
        <div>
            <canvas ref={ref} className="signature-canvas" width={700} height={150}
                onMouseDown={start} onMouseMove={draw} onMouseUp={stop} onMouseLeave={stop}
                onTouchStart={start} onTouchMove={draw} onTouchEnd={stop} />
            <button className="btn btn-secondary" style={{marginTop:'8px', padding:'8px 16px', fontSize:'13px'}} onClick={clear}>Limpiar</button>
        </div>
    );
}

// New Order Form
function NewOrderForm({ onSave, editingOrder }) {
    const emptyOrder = {
        id: Date.now(),
        otNumber: `OT-${Date.now().toString().slice(-6)}`,
        fecha: new Date().toISOString().split('T')[0],
        // Datos internos (no aparecen en certificado)
        ordenVenta: '', nroRemito: '',
        // Datos v√°lvula
        cliente: '', locacion: '', equipo: '', ubicacion: '',
        mesReparacion: '', anioReparacion: new Date().getFullYear().toString(),
        marca: '', modelo: '', nroSerie: '', presion: '', fluido: '',
        norma: '', tamano: '', tipoConexion: '', precinto: '',
        observaciones: '', recomendaciones: '',
        // Fotos
        fotoEntrada: '', fotoSalida: '',
        fotoDisco: '', fotoPlatillos: '',
        fotoAsiento: '', fotoVastago: '', fotoResorte: '',
        // Desmonte/montaje checkboxes
        dm: {
            corteEsparrago: false, soldadoConexionEntrada: false,
            corteConexionEnt: false, soldadoConexionSalida: false,
            corteConexionSalida: false, transporteDeTaller: false,
            izaje: false, transporteATaller: false,
        },
        // Desarmado checkboxes
        des: {
            fotoDeLlegada: false, desmontajeBonete: false,
            regCompresionResorte: false, extraccionComponentes: false,
            marcadoAlineacion: false, registroDimensiones: false,
            descompresionResorte: false, fotografico: false,
        },
        // Dimensiones - Asiento
        diaExternolabioD1: '', diaInternoLabioD2: '', diaGargantaD3: '',
        // Dimensiones - Disco/Gu√≠a
        diaExternoPiston: '', diaInternoGuia: '', toleranciaGuiaPiston: '',
        // Dimensiones - Resorte
        diaExternoOD: '', diaAlambreD: '', longitudTotalL: '',
        vueltasActivas: '', espacioEntreVueltas: '', desvioPerpendicular: '',
        // Firma
        firma: '',
        status: 'draft',
        updatedAt: new Date().toISOString()
    };

    const [form, setForm] = useState(editingOrder || emptyOrder);
    const [saving, setSaving] = useState(false);
    const [uploading, setUploading] = useState(false);

    const set = (f, v) => setForm(prev => ({ ...prev, [f]: v }));
    const setDM = (f, v) => setForm(prev => ({ ...prev, dm: { ...prev.dm, [f]: v } }));
    const setDes = (f, v) => setForm(prev => ({ ...prev, des: { ...prev.des, [f]: v } }));

    const handleSave = async (draft = false) => {
        setSaving(true);
        await onSave({ ...form, status: draft ? 'draft' : 'complete', updatedAt: new Date().toISOString() });
        setSaving(false);
    };

    const generateCert = () => {
        const w = window.open('', '_blank');
        const dm = form.dm || {};
        const des = form.des || {};
        const X = (v) => v ? 'X' : '';
        const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>Certificado ${form.otNumber}</title>
<style>
@page { size: A4; margin: 0; }
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: Arial, sans-serif; width:210mm; background:white; font-size:9px; }
.page { width:210mm; padding:8mm; }
.header { display:flex; justify-content:space-between; align-items:center; border:2px solid #333; padding:10px; margin-bottom:4px; }
.header-left h2 { font-size:16px; font-weight:900; }
.header-left h3 { font-size:13px; font-weight:700; }
.header-center { text-align:center; }
.galileo { font-size:18px; font-weight:900; color:#1a5f7a; font-style:italic; }
.header-right { text-align:right; }
.header-right .dario { font-size:16px; font-weight:900; font-family:'Arial Black',sans-serif; }
.header-right .oilgas { font-size:10px; }
.header-right .dir { font-size:8px; color:#555; margin-top:4px; }
table { width:100%; border-collapse:collapse; }
td, th { border:1px solid #999; padding:3px 5px; font-size:8.5px; }
.section-title { background:#1a5f7a; color:white; text-align:center; font-weight:700; padding:4px; font-size:9px; letter-spacing:1px; }
.gray { background:#f0f0f0; font-weight:700; }
.photo-box { border:1px solid #999; width:100%; aspect-ratio:1.4; display:flex; align-items:center; justify-content:center; overflow:hidden; }
.photo-box img { width:100%; height:100%; object-fit:cover; }
.photo-empty { background:#f5f5f5; color:#bbb; font-size:20px; }
.foto-label { text-align:center; font-weight:700; font-size:8px; padding:3px; background:#f0f0f0; border:1px solid #999; border-top:none; }
.cb { width:12px; height:12px; border:1px solid #333; display:inline-flex; align-items:center; justify-content:center; font-size:9px; font-weight:700; }
.row-info { display:flex; gap:4px; margin-bottom:4px; align-items:stretch; }
.no-print { position:fixed; top:15px; right:15px; background:#FF6B35; color:white; padding:12px 24px; border-radius:8px; cursor:pointer; font-weight:700; font-size:14px; border:none; z-index:999; }
@media print { .no-print { display:none; } }
</style></head><body>
<div class="page">

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <h2>CERTIFICADO  CALIBRACI√ìN</h2>
    <h3>DE VALVULAS N¬∞${form.otNumber}</h3>
  </div>
  <div class="header-center">
    <div style="font-size:9px;font-style:italic;color:#555;">Service oficial</div>
    <div class="galileo">GALILEO</div>
    <div style="font-size:8px;color:#888;">Tecnolog√≠as</div>
  </div>
  <div class="header-right">
    <div class="dario">DARIO WALTER</div>
    <div class="oilgas">Oil & Gas Solutions</div>
    <div class="dir">Vintter 965, Gral Roca (R.N)</div>
  </div>
</div>

<!-- CLIENTE / EQUIPO -->
<table style="margin-bottom:3px;">
  <tr>
    <td class="gray" style="width:12%;">CLIENTE</td>
    <td style="width:35%;">${form.cliente}</td>
    <td class="gray" style="width:10%;">EQUIPO</td>
    <td style="width:20%;">${form.equipo}</td>
    <td class="gray" style="width:10%;">UBICACI√ìN</td>
    <td>${form.ubicacion}</td>
  </tr>
</table>

<!-- LOCACION / MES -->
<table style="margin-bottom:3px;">
  <tr>
    <td class="gray" style="width:12%;">LOCACI√ìN:</td>
    <td style="width:35%;">${form.locacion}</td>
    <td class="gray" style="width:28%;">MES REPARACI√ìN RECALIBRACI√ìN:</td>
    <td style="width:13%;">${form.mesReparacion}</td>
    <td style="width:12%;">${form.anioReparacion}</td>
  </tr>
</table>

<!-- DATOS + FOTO ENTRADA + OBSERVACIONES + FOTO SALIDA -->
<table style="margin-bottom:3px;">
  <tr>
    <td style="width:22%;vertical-align:top;">
      <table style="width:100%;border:none;">
        <tr><td colspan="2" class="gray" style="text-align:center;font-size:8px;">DATOS V√ÅLVULAS</td></tr>
        <tr><td class="gray">MARCA:</td><td>${form.marca}</td></tr>
        <tr><td class="gray">MODELO:</td><td>${form.modelo}</td></tr>
        <tr><td class="gray">N¬∫ SERIE:</td><td>${form.nroSerie}</td></tr>
        <tr><td class="gray">PRESI√ìN</td><td>${form.presion} BAR</td></tr>
        <tr><td class="gray">FLUIDO:</td><td>${form.fluido}</td></tr>
        <tr><td class="gray">NORMA:</td><td>${form.norma}</td></tr>
        <tr><td class="gray">TAMA√ëO ENT Y SAL</td><td>${form.tamano}</td></tr>
        <tr><td class="gray">TIPO CONEXI√ìN:</td><td>${form.tipoConexion}</td></tr>
        <tr><td class="gray">PRECINTO:</td><td>${form.precinto}</td></tr>
      </table>
    </td>
    <td style="width:25%;vertical-align:top;padding:4px;">
      <div style="font-weight:700;font-size:8px;margin-bottom:4px;">OBSERVACIONES</div>
      <div style="font-size:8px;min-height:50px;">${form.observaciones}</div>
      <div style="font-weight:700;font-size:8px;margin:8px 0 4px;">RECOMENDACIONES</div>
      <div style="font-size:8px;min-height:50px;">${form.recomendaciones}</div>
    </td>
    <td style="width:25%;vertical-align:top;padding:4px;">
      <div class="photo-box ${form.fotoEntrada ? '' : 'photo-empty'}">
        ${form.fotoEntrada ? `<img src="${form.fotoEntrada}" />` : 'üì∑'}
      </div>
      <div class="foto-label">FOTO GENERAL: ENTRADA</div>
    </td>
    <td style="width:25%;vertical-align:top;padding:4px;">
      <div class="photo-box ${form.fotoSalida ? '' : 'photo-empty'}">
        ${form.fotoSalida ? `<img src="${form.fotoSalida}" />` : 'üì∑'}
      </div>
      <div class="foto-label">FOTO GENERAL: SALIDA</div>
    </td>
  </tr>
</table>

<!-- FOTOS COMPONENTES -->
<div class="section-title">REGISTRO FOTOGR√ÅFICO ESTADO COMPONENTES COMO SE ENCONTRARON</div>
<table style="margin-bottom:3px;">
  <tr>
    <td style="width:33%;padding:4px;">
      <div class="photo-box ${form.fotoDisco ? '' : 'photo-empty'}">
        ${form.fotoDisco ? `<img src="${form.fotoDisco}" />` : 'üì∑'}
      </div>
      <div class="foto-label">DISCO</div>
    </td>
    <td style="width:33%;padding:4px;">
      <div class="photo-box ${form.fotoPlatillos ? '' : 'photo-empty'}">
        ${form.fotoPlatillos ? `<img src="${form.fotoPlatillos}" />` : 'üì∑'}
      </div>
      <div class="foto-label">PLATILLOS</div>
    </td>
    <td style="width:33%;padding:4px;">
      <div class="photo-box ${form.fotoAsiento ? '' : 'photo-empty'}">
        ${form.fotoAsiento ? `<img src="${form.fotoAsiento}" />` : 'üì∑'}
      </div>
      <div class="foto-label">ASIENTO</div>
    </td>
  </tr>
  <tr>
    <td style="padding:4px;">
      <div class="photo-box ${form.fotoVastago ? '' : 'photo-empty'}">
        ${form.fotoVastago ? `<img src="${form.fotoVastago}" />` : 'üì∑'}
      </div>
      <div class="foto-label">V√ÅSTAGO</div>
    </td>
    <td style="padding:4px;">
      <div class="photo-box ${form.fotoResorte ? '' : 'photo-empty'}">
        ${form.fotoResorte ? `<img src="${form.fotoResorte}" />` : 'üì∑'}
      </div>
      <div class="foto-label">RESORTE</div>
    </td>
    <td style="padding:4px;"></td>
  </tr>
</table>

<!-- DESMONTE/DESARMADO -->
<div class="section-title">DESCRIPCI√ìN DE DESMONTE, DESARMADO Y REGISTRO DIMENSIONES B√ÅSICAS</div>
<table style="margin-bottom:3px;">
  <tr>
    <td style="width:33%;vertical-align:top;">
      <div class="gray" style="text-align:center;padding:3px;font-weight:700;">DESMONTE/MONTAJE</div>
      <table style="width:100%;border:none;">
        <tr><td>CORTE DE ESPARRAGO</td><td style="width:20px;text-align:center;"><div class="cb">${X(dm.corteEsparrago)}</div></td><td>SOLDADO CONEXI√ìN ENTRADA</td><td style="width:20px;text-align:center;"><div class="cb">${X(dm.soldadoConexionEntrada)}</div></td></tr>
        <tr><td>CORTE CONEXI√ìN DE ENT.</td><td style="text-align:center;"><div class="cb">${X(dm.corteConexionEnt)}</div></td><td>SOLDADO CONEXI√ìN SALIDA</td><td style="text-align:center;"><div class="cb">${X(dm.soldadoConexionSalida)}</div></td></tr>
        <tr><td>CORTE CONEXI√ìN DE SALIDA</td><td style="text-align:center;"><div class="cb">${X(dm.corteConexionSalida)}</div></td><td>TRANSPORTE DE TALLER</td><td style="text-align:center;"><div class="cb">${X(dm.transporteDeTaller)}</div></td></tr>
        <tr><td>IZAJE</td><td style="text-align:center;"><div class="cb">${X(dm.izaje)}</div></td><td>TRANSPORTE A TALLER</td><td style="text-align:center;"><div class="cb">${X(dm.transporteATaller)}</div></td></tr>
      </table>
    </td>
    <td style="width:33%;vertical-align:top;">
      <div class="gray" style="text-align:center;padding:3px;font-weight:700;">DESARMADO</div>
      <table style="width:100%;border:none;">
        <tr><td>FOTO DE LLEGADA AL TALLER</td><td style="width:20px;text-align:center;"><div class="cb">${X(des.fotoDeLlegada)}</div></td><td>DESMONTAJE BONETE</td><td style="width:20px;text-align:center;"><div class="cb">${X(des.desmontajeBonete)}</div></td></tr>
        <tr><td>REG. COMPRESI√ìN RESORTE</td><td style="text-align:center;"><div class="cb">${X(des.regCompresionResorte)}</div></td><td>EXTRACCI√ìN COMPONENTES</td><td style="text-align:center;"><div class="cb">${X(des.extraccionComponentes)}</div></td></tr>
        <tr><td>MARCADO ALINEACI√ìN BONETE Y CUERPO</td><td style="text-align:center;"><div class="cb">${X(des.marcadoAlineacion)}</div></td><td>REGISTRO DIMENSIONES Y FOTOGR√ÅFICO</td><td style="text-align:center;"><div class="cb">${X(des.registroDimensiones)}</div></td></tr>
        <tr><td>DESCOMPRESI√ìN DE RESORTE</td><td style="text-align:center;"><div class="cb">${X(des.descompresionResorte)}</div></td><td></td><td></td></tr>
      </table>
    </td>
  </tr>
</table>

<!-- DIMENSIONES REGISTRADAS -->
<div class="section-title">DIMENSIONES REGISTRADAS</div>
<table style="margin-bottom:8px;">
  <tr>
    <td style="width:33%;vertical-align:top;">
      <div class="gray" style="text-align:center;padding:3px;font-weight:700;">ASIENTO DE LA V√ÅLVULA</div>
      <table style="width:100%;border:none;">
        <tr><td>DIA. EXTERNO LABIO ASIENTO, D1</td><td style="width:40px;">${form.diaExternolabioD1}</td><td>mm</td></tr>
        <tr><td>DIA. INTERNO LABIO ASIENTO, D2</td><td>${form.diaInternoLabioD2}</td><td>mm</td></tr>
        <tr><td>DIA. DE LA GARGANTA, D3</td><td>${form.diaGargantaD3}</td><td>mm</td></tr>
      </table>
    </td>
    <td style="width:33%;vertical-align:top;">
      <div class="gray" style="text-align:center;padding:3px;font-weight:700;">DISCO / GU√çA</div>
      <table style="width:100%;border:none;">
        <tr><td>DIA. EXTERNO PISTON</td><td style="width:40px;">${form.diaExternoPiston}</td><td>mm</td></tr>
        <tr><td>DIA. INTERNO GUIA</td><td>${form.diaInternoGuia}</td><td>mm</td></tr>
        <tr><td>TOLERANCIA GUIA / PISTON</td><td>${form.toleranciaGuiaPiston}</td><td>mm</td></tr>
      </table>
    </td>
    <td style="width:33%;vertical-align:top;">
      <div class="gray" style="text-align:center;padding:3px;font-weight:700;">RESORTE</div>
      <table style="width:100%;border:none;">
        <tr><td>DIA. EXTERNO, O.D</td><td style="width:40px;">${form.diaExternoOD}</td><td>mm</td></tr>
        <tr><td>DIA. ALAMBRE, d</td><td>${form.diaAlambreD}</td><td>mm</td></tr>
        <tr><td>LONGITUD TOTAL, L</td><td>${form.longitudTotalL}</td><td>mm</td></tr>
        <tr><td>VUELTAS ACTIVAS</td><td>${form.vueltasActivas}</td><td></td></tr>
        <tr><td>ESPACIO ENTRE VUELTAS, P</td><td>${form.espacioEntreVueltas}</td><td>mm</td></tr>
        <tr><td>DESVIO DE PERPENDICULAR</td><td>${form.desvioPerpendicular}</td><td>mm</td></tr>
      </table>
    </td>
  </tr>
</table>

</div>
<button class="no-print" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
</body></html>`;
        w.document.write(html);
        w.document.close();
    };

    const checkboxesDM = [
        ['corteEsparrago', 'Corte Esparrago'],
        ['soldadoConexionEntrada', 'Soldado Conexi√≥n Entrada'],
        ['corteConexionEnt', 'Corte Conexi√≥n de Ent.'],
        ['soldadoConexionSalida', 'Soldado Conexi√≥n Salida'],
        ['corteConexionSalida', 'Corte Conexi√≥n de Salida'],
        ['transporteDeTaller', 'Transporte de Taller'],
        ['izaje', 'Izaje'],
        ['transporteATaller', 'Transporte a Taller'],
    ];

    const checkboxesDes = [
        ['fotoDeLlegada', 'Foto de Llegada al Taller'],
        ['desmontajeBonete', 'Desmontaje Bonete'],
        ['regCompresionResorte', 'Reg. Compresi√≥n Resorte'],
        ['extraccionComponentes', 'Extracci√≥n Componentes'],
        ['marcadoAlineacion', 'Marcado Alineaci√≥n Bonete y Cuerpo'],
        ['registroDimensiones', 'Registro Dimensiones y Fotogr√°fico'],
        ['descompresionResorte', 'Descompresi√≥n de Resorte'],
    ];

    return (
        <div>
            {/* INFO GENERAL */}
            <div className="card">
                <div className="card-title">üìã Datos de la Orden</div>
                <div className="form-row">
                    <div className="form-group">
                        <label className="form-label">N¬∞ OT</label>
                        <input className="form-input" value={form.otNumber} readOnly style={{background:'#f5f5f5'}} />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Fecha</label>
                        <input type="date" className="form-input" value={form.fecha} onChange={e => set('fecha', e.target.value)} />
                    </div>
                </div>

                {/* Campos internos - no aparecen en el certificado */}
                <div style={{background:'#FFF8E1', border:'2px solid #FFB800', borderRadius:'12px', padding:'16px', marginBottom:'8px'}}>
                    <div style={{fontSize:'12px', fontWeight:'700', color:'#F59E0B', marginBottom:'12px', display:'flex', alignItems:'center', gap:'6px'}}>
                        üîí DATOS INTERNOS ‚Äî No aparecen en el certificado
                    </div>
                    <div className="form-row">
                        <div className="form-group" style={{marginBottom:'0'}}>
                            <label className="form-label">Orden de Venta</label>
                            <input className="form-input" value={form.ordenVenta} onChange={e => set('ordenVenta', e.target.value)} placeholder="N¬∞ Orden de Venta" style={{borderColor:'#FFB800'}} />
                        </div>
                        <div className="form-group" style={{marginBottom:'0'}}>
                            <label className="form-label">N¬∞ Remito</label>
                            <input className="form-input" value={form.nroRemito} onChange={e => set('nroRemito', e.target.value)} placeholder="N¬∞ de Remito" style={{borderColor:'#FFB800'}} />
                        </div>
                    </div>
                </div>
                <div className="form-row">
                    <div className="form-group">
                        <label className="form-label">Cliente</label>
                        <input className="form-input" value={form.cliente} onChange={e => set('cliente', e.target.value)} placeholder="Ej: GALILEO TECHNOLOGIES S.A." />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Locaci√≥n</label>
                        <input className="form-input" value={form.locacion} onChange={e => set('locacion', e.target.value)} />
                    </div>
                </div>
                <div className="form-row">
                    <div className="form-group">
                        <label className="form-label">Equipo</label>
                        <input className="form-input" value={form.equipo} onChange={e => set('equipo', e.target.value)} placeholder="Ej: MP 878" />
                    </div>
                    <div className="form-group">
                        <label className="form-label">Ubicaci√≥n / Presi√≥n</label>
                        <input className="form-input" value={form.ubicacion} onChange={e => set('ubicacion', e.target.value)} placeholder="Ej: PRESION DE ENTRADA" />
                    </div>
                </div>
                <div className="form-row">
                    <div className="form-group">
                        <label className="form-label">Mes Reparaci√≥n</label>
                        <select className="form-input" value={form.mesReparacion} onChange={e => set('mesReparacion', e.target.value)}>
                            <option value="">Seleccionar</option>
                            {['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'].map(m => <option key={m}>{m}</option>)}
                        </select>
                    </div>
                    <div className="form-group">
                        <label className="form-label">A√±o</label>
                        <input className="form-input" value={form.anioReparacion} onChange={e => set('anioReparacion', e.target.value)} />
                    </div>
                </div>
            </div>

            {/* DATOS V√ÅLVULA */}
            <div className="card">
                <div className="card-title">üîß Datos de la V√°lvula</div>
                <div className="form-row">
                    <div className="form-group"><label className="form-label">Marca</label><input className="form-input" value={form.marca} onChange={e => set('marca', e.target.value)} /></div>
                    <div className="form-group"><label className="form-label">Modelo</label><input className="form-input" value={form.modelo} onChange={e => set('modelo', e.target.value)} /></div>
                </div>
                <div className="form-row">
                    <div className="form-group"><label className="form-label">N¬∞ Serie</label><input className="form-input" value={form.nroSerie} onChange={e => set('nroSerie', e.target.value)} /></div>
                    <div className="form-group"><label className="form-label">Presi√≥n (BAR)</label><input className="form-input" value={form.presion} onChange={e => set('presion', e.target.value)} /></div>
                </div>
                <div className="form-row">
                    <div className="form-group"><label className="form-label">Fluido</label><input className="form-input" value={form.fluido} onChange={e => set('fluido', e.target.value)} /></div>
                    <div className="form-group"><label className="form-label">Norma</label><input className="form-input" value={form.norma} onChange={e => set('norma', e.target.value)} /></div>
                </div>
                <div className="form-row">
                    <div className="form-group"><label className="form-label">Tama√±o Ent. y Sal.</label><input className="form-input" value={form.tamano} onChange={e => set('tamano', e.target.value)} placeholder='Ej: 1" X 1 1/2"' /></div>
                    <div className="form-group"><label className="form-label">Tipo Conexi√≥n</label><input className="form-input" value={form.tipoConexion} onChange={e => set('tipoConexion', e.target.value)} /></div>
                </div>
                <div className="form-row">
                    <div className="form-group"><label className="form-label">Precinto</label><input className="form-input" value={form.precinto} onChange={e => set('precinto', e.target.value)} /></div>
                </div>
                <div className="form-group"><label className="form-label">Observaciones</label><textarea className="form-input" style={{minHeight:'80px',resize:'vertical'}} value={form.observaciones} onChange={e => set('observaciones', e.target.value)} /></div>
                <div className="form-group"><label className="form-label">Recomendaciones</label><textarea className="form-input" style={{minHeight:'80px',resize:'vertical'}} value={form.recomendaciones} onChange={e => set('recomendaciones', e.target.value)} /></div>
            </div>

            {/* FOTOS */}
            <div className="card">
                <div className="card-title">üì∏ Registro Fotogr√°fico</div>
                <div className="photos-grid">
                    {[
                        ['fotoEntrada','Foto General: Entrada'],
                        ['fotoSalida','Foto General: Salida'],
                        ['fotoDisco','Disco'],
                        ['fotoPlatillos','Platillos'],
                        ['fotoAsiento','Asiento'],
                        ['fotoVastago','V√°stago'],
                        ['fotoResorte','Resorte'],
                    ].map(([key, label]) => (
                        <PhotoSlot key={key} label={label} photo={form[key]} uploading={uploading}
                            onChange={url => set(key, url)} />
                    ))}
                </div>
            </div>

            {/* DESMONTE/MONTAJE */}
            <div className="card">
                <div className="card-title">‚úÖ Desmonte / Montaje</div>
                <div className="checkbox-grid">
                    {checkboxesDM.map(([key, label]) => (
                        <label key={key} className={`checkbox-item ${form.dm?.[key] ? 'checked' : ''}`}>
                            <input type="checkbox" checked={!!form.dm?.[key]} onChange={e => setDM(key, e.target.checked)} />
                            {label}
                        </label>
                    ))}
                </div>
            </div>

            {/* DESARMADO */}
            <div className="card">
                <div className="card-title">üî© Desarmado</div>
                <div className="checkbox-grid">
                    {checkboxesDes.map(([key, label]) => (
                        <label key={key} className={`checkbox-item ${form.des?.[key] ? 'checked' : ''}`}>
                            <input type="checkbox" checked={!!form.des?.[key]} onChange={e => setDes(key, e.target.checked)} />
                            {label}
                        </label>
                    ))}
                </div>
            </div>

            {/* DIMENSIONES */}
            <div className="card">
                <div className="card-title">üìê Dimensiones Registradas</div>
                <div className="form-row-3">
                    <div>
                        <div style={{fontWeight:'700',marginBottom:'12px',color:'var(--primary)'}}>Asiento de la V√°lvula</div>
                        {[['diaExternolabioD1','DIA. Externo Labio Asiento, D1'],['diaInternoLabioD2','DIA. Interno Labio Asiento, D2'],['diaGargantaD3','DIA. de la Garganta, D3']].map(([k,l]) => (
                            <div key={k} className="form-group">
                                <label className="form-label" style={{fontSize:'12px'}}>{l}</label>
                                <div style={{display:'flex',gap:'8px',alignItems:'center'}}>
                                    <input className="form-input" style={{flex:1}} value={form[k]} onChange={e => set(k, e.target.value)} placeholder="0.0" />
                                    <span style={{fontWeight:'600',color:'#666'}}>mm</span>
                                </div>
                            </div>
                        ))}
                    </div>
                    <div>
                        <div style={{fontWeight:'700',marginBottom:'12px',color:'var(--primary)'}}>Disco / Gu√≠a</div>
                        {[['diaExternoPiston','DIA. Externo Pist√≥n'],['diaInternoGuia','DIA. Interno Gu√≠a'],['toleranciaGuiaPiston','Tolerancia Gu√≠a / Pist√≥n']].map(([k,l]) => (
                            <div key={k} className="form-group">
                                <label className="form-label" style={{fontSize:'12px'}}>{l}</label>
                                <div style={{display:'flex',gap:'8px',alignItems:'center'}}>
                                    <input className="form-input" style={{flex:1}} value={form[k]} onChange={e => set(k, e.target.value)} placeholder="0.0" />
                                    <span style={{fontWeight:'600',color:'#666'}}>mm</span>
                                </div>
                            </div>
                        ))}
                    </div>
                    <div>
                        <div style={{fontWeight:'700',marginBottom:'12px',color:'var(--primary)'}}>Resorte</div>
                        {[['diaExternoOD','DIA. Externo, O.D'],['diaAlambreD','DIA. Alambre, d'],['longitudTotalL','Longitud Total, L'],['vueltasActivas','Vueltas Activas'],['espacioEntreVueltas','Espacio entre Vueltas, P'],['desvioPerpendicular','Desvio de Perpendicular']].map(([k,l]) => (
                            <div key={k} className="form-group">
                                <label className="form-label" style={{fontSize:'12px'}}>{l}</label>
                                <div style={{display:'flex',gap:'8px',alignItems:'center'}}>
                                    <input className="form-input" style={{flex:1}} value={form[k]} onChange={e => set(k, e.target.value)} placeholder="0.0" />
                                    <span style={{fontWeight:'600',color:'#666'}}>mm</span>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>

            {/* FIRMA */}
            <div className="card">
                <div className="card-title">‚úçÔ∏è Firma del T√©cnico</div>
                <SignaturePad sig={form.firma} onChange={v => set('firma', v)} />
            </div>

            {/* BOTONES */}
            <div className="btn-group">
                <button className="btn btn-secondary" style={{flex:1}} onClick={() => handleSave(true)} disabled={saving}>
                    {saving ? '‚è≥...' : 'üíæ Guardar Borrador'}
                </button>
                <button className="btn btn-success" style={{flex:1}} onClick={generateCert}>
                    üìÑ Generar Certificado
                </button>
                <button className="btn btn-primary" style={{flex:1}} onClick={() => handleSave(false)} disabled={saving}>
                    {saving ? '‚è≥...' : '‚úì Completar OT'}
                </button>
            </div>
        </div>
    );
}

// Orders List
function OrdersList({ onNew, onEdit }) {
    const [orders, setOrders] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const unsub = Storage.getOrders(o => { setOrders(o); setLoading(false); });
        return () => unsub();
    }, []);

    if (loading) return <div className="card"><div className="loading"><div style={{fontSize:'48px'}}>‚è≥</div><p>Cargando √≥rdenes...</p></div></div>;

    if (!orders.length) return (
        <div className="card">
            <div className="empty-state">
                <div style={{fontSize:'64px',marginBottom:'20px'}}>üîß</div>
                <h3>No hay √≥rdenes registradas</h3>
                <p>Cre√° tu primera orden de trabajo</p>
                <button className="btn btn-primary" style={{marginTop:'20px'}} onClick={onNew}>‚ûï Nueva Orden</button>
            </div>
        </div>
    );

    return (
        <div>
            <button className="btn btn-primary btn-full" style={{marginBottom:'20px'}} onClick={onNew}>‚ûï Nueva Orden de Trabajo</button>
            {orders.map(o => (
                <div key={o.firestoreId||o.id} className="order-card" onClick={() => onEdit(o)}>
                    <div className="order-header">
                        <div className="order-title">{o.otNumber} ‚Äî {o.nroSerie || 'Sin serie'}</div>
                        <span className={`order-badge ${o.status === 'complete' ? 'badge-complete' : 'badge-draft'}`}>
                            {o.status === 'complete' ? 'Completo' : 'Borrador'}
                        </span>
                    </div>
                    <div className="order-details">
                        <div><span className="detail-label">Cliente:</span> {o.cliente || '-'}</div>
                        <div><span className="detail-label">Marca:</span> {o.marca || '-'}</div>
                        <div><span className="detail-label">Modelo:</span> {o.modelo || '-'}</div>
                        <div><span className="detail-label">Fecha:</span> {o.fecha || '-'}</div>
                        <div><span className="detail-label">Presi√≥n:</span> {o.presion ? o.presion+' BAR' : '-'}</div>
                        <div><span className="detail-label">Fluido:</span> {o.fluido || '-'}</div>
                    </div>
                    {(o.ordenVenta || o.nroRemito) && (
                        <div style={{marginTop:'10px', padding:'8px 12px', background:'#FFF8E1', borderRadius:'8px', display:'flex', gap:'20px', fontSize:'13px'}}>
                            {o.ordenVenta && <span>üîí <strong>OV:</strong> {o.ordenVenta}</span>}
                            {o.nroRemito && <span>üîí <strong>Remito:</strong> {o.nroRemito}</span>}
                        </div>
                    )}
                </div>
            ))}
        </div>
    );
}

// App
function App() {
    const [tab, setTab] = useState('list');
    const [editing, setEditing] = useState(null);
    const [toast, setToast] = useState(null);
    const [online, setOnline] = useState(navigator.onLine);

    useEffect(() => {
        const on = () => setOnline(true);
        const off = () => setOnline(false);
        window.addEventListener('online', on);
        window.addEventListener('offline', off);
        return () => { window.removeEventListener('online', on); window.removeEventListener('offline', off); };
    }, []);

    const showToast = (msg, type = 'success') => setToast({ msg, type });

    const handleSave = async (order) => {
        const ok = await Storage.saveOrder(order);
        if (ok) {
            showToast(order.status === 'draft' ? 'üíæ Borrador guardado' : '‚úÖ Orden completada');
            setTab('list'); setEditing(null);
        } else {
            showToast('Error al guardar', 'error');
        }
    };

    return (
        <div className="app-container">
            <div className="app-header">
                <h1>ValvuCheck</h1>
                <div className="subtitle">Sistema de Calibraci√≥n Digital de V√°lvulas</div>
                <div className="sync-status">
                    <div className="sync-dot" style={{background: online ? '#06D6A0' : '#FFB800'}}></div>
                    {online ? 'Sincronizado ‚òÅÔ∏è' : 'Offline'}
                </div>
            </div>

            <div className="nav-tabs">
                <button className={`nav-tab ${tab==='list'?'active':''}`} onClick={() => setTab('list')}>üìã √ìrdenes</button>
                <button className={`nav-tab ${tab==='new'?'active':''}`} onClick={() => { setEditing(null); setTab('new'); }}>‚ûï Nueva OT</button>
            </div>

            {tab === 'list'
                ? <OrdersList onNew={() => { setEditing(null); setTab('new'); }} onEdit={o => { setEditing(o); setTab('new'); }} />
                : <NewOrderForm onSave={handleSave} editingOrder={editing} />
            }

            {toast && <Toast message={toast.msg} type={toast.type} onClose={() => setToast(null)} />}
        </div>
    );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
